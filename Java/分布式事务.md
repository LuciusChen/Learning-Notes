事务的四大特性：原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）和持久性（Durability），简称 ACID。

在单体架构时代，所有的业务只用一个数据库，利用数据库本身提供的事务机制支持就可以。例如 MySQL 数据库：事务的隔离性是通过数据库锁的机现的。事务的一致性由「undo log」来保证：「undo log」是逻辑日志，记录了事务的`insert`、`update`、`delete`操作，回滚的时候做相反的`delete`、`update`、`insert`操作来恢复数据。事务的原子性和一持久性由「redo log」来制实保证：「redo log」被称作重做日志，是物理日志，事务提交的时候，必须先将事务的所有日志写入「redo log」持久化，到事务的提交操作才算完成。

## 分布式事务

![](/Java/images/Distributed%20transaction%20management.png)

[CAP](/Java/CAP.md) 理论，无法都满足，其中 P 是分布式的基础，只能根据实际情况在 C 和 A 中取舍，演化成 [BASE](/Java/CAP.md#BASE-理论) 理论。

「XA」是一个分布式事务协议，由「Tuxedo」提出。在这个协议里，有三个角色：AP（Application）：应用系统（服务）、TM（Transaction Manager）：事务管理器（全局事务管理）、RM（Resource Manager）：资源管理器（数据库）。XA 规范主要定义了事务管理器（Transaction Manager）和资源管理器（Resource Manager）之间的接口。

![](/Java/images/XA.png)

「XA」协议采用「两阶段提交」方式来管理分布式事务。「XA」接口提供资源管理器与事务管理器之间进行通信的标准接口。

### 2PC 两阶段提交

两阶段提交的思路可以概括为：参与者将操作成败通知协调者，再由协调者根据所有参与者的反馈情况决定各参与者是否要提交操作还是中止操作。

![](/Java/images/2PC.png)

两阶段提交优点：尽量保证了数据的强一致，但不是100%一致。

两阶段提交同样有一些缺点：
- 单点故障 
  由于协调者的重要性，一旦协调者发生故障，参与者会一直阻塞，尤其时在第二阶段，协调者发生故障，那么所有的参与者都处于锁定事务资源的状态中，而无法继续完成事务操作。 
- 同步阻塞 
  它是一个强一致性的同步阻塞协议，也就是所谓刚性事务，事务执⾏过程中需要将所需资源全部锁定，会比较影响性能。 
- 数据不一致 
  在第二阶段中，当协调者想参与者发送提交事务请求之后，由于网络抖动，如果第二阶段只有部分参与者收到提交请求，那么就会导致数据不一致。

### 3PC 三阶段提交

三阶段提交「3PC」是二阶段提交「2PC」的一种改进版本 ，为解决两阶段提交协议的单点故障和同步阻塞问题。上边提到两阶段提交，当协调者崩溃时，参与者不能做出最后的选择，就会一直保持阻塞锁定资源。「2PC」中只有协调者有超时机制，「3PC」在协调者和参与者中都引入了超时机制，协调者出现故障后，参与者就不会一直阻塞。而且在第一阶段和第二阶段中又插入了一个预提交阶段，保证了在最后提交阶段之前各参与节点的状态是一致的。



### TODO

- [ ] undo log
- [ ] redo log